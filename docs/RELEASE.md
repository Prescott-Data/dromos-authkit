# Release Guide

This guide explains how to create releases for dromos-authkit.

## Release Process

We use [semantic versioning](https://semver.org/) (MAJOR.MINOR.PATCH):

- **MAJOR**: Incompatible API changes
- **MINOR**: New functionality, backwards compatible
- **PATCH**: Bug fixes, backwards compatible

## Automated Release with GitHub Actions

### Option 1: Using the Tag Workflow (Recommended)

1. **Update CHANGELOG.md** with the new version and changes:

   ```bash
   # Update CHANGELOG.md with version and date
   vim CHANGELOG.md
   ```

2. **Commit and push changes**:

   ```bash
   git add CHANGELOG.md
   git commit -m "chore: prepare release v1.0.0"
   git push origin main
   ```

3. **Create tag via GitHub Actions**:
   - Go to GitHub Actions → Tag workflow
   - Click "Run workflow"
   - Enter the version (e.g., `v1.0.0`)
   - Click "Run workflow"

4. **The release workflow will automatically**:
   - Create the tag
   - Trigger the release workflow
   - Generate release notes
   - Publish the release to GitHub

### Option 2: Manual Tag Creation

1. **Update CHANGELOG.md** (same as above)

2. **Commit and push changes**:

   ```bash
   git add CHANGELOG.md
   git commit -m "chore: prepare release v1.0.0"
   git push origin main
   ```

3. **Create and push tag**:

   ```bash
   git tag -a v1.0.0 -m "Release v1.0.0"
   git push origin v1.0.0
   ```

4. **GitHub Actions will automatically**:
   - Run tests
   - Create a GitHub release
   - Generate release notes from commits
   - Make the module available via Go's module proxy

## Pre-release Checklist

Before creating a release, ensure:

- [ ] All tests pass: `make test`
- [ ] Linter passes: `make lint`
- [ ] Go modules are tidy: `make tidy`
- [ ] CHANGELOG.md is updated with version and date
- [ ] Version follows semantic versioning
- [ ] Breaking changes are documented
- [ ] Migration guide exists (for breaking changes)

## Release Notes

Release notes are automatically generated from commit messages using conventional commits:

- `feat:` → New Features
- `fix:` → Bug Fixes
- `perf:` → Performance Improvements
- `build(deps):` → Dependency Updates

To write good commit messages:

```bash
feat(auth): add support for custom claims validation
fix(rbac): correct role check logic for nested roles
perf(jwks): optimize cache refresh mechanism
```

## Testing a Release

After creating a release, test it:

1. **Install the new version**:

   ```bash
   go get github.com/Prescott-Data/dromos-authkit@v1.0.0
   ```

2. **Verify in a test project**:

   ```bash
   mkdir test-release && cd test-release
   go mod init test
   go get github.com/Prescott-Data/dromos-authkit@v1.0.0
   ```

3. **Check on pkg.go.dev**:
   - Visit https://pkg.go.dev/github.com/Prescott-Data/dromos-authkit@v1.0.0
   - Verify documentation is correct

## Hotfix Releases

For critical bugs in production:

1. Create a hotfix branch from the release tag:

   ```bash
   git checkout -b hotfix/v1.0.1 v1.0.0
   ```

2. Fix the bug and commit:

   ```bash
   git commit -am "fix: critical security issue"
   ```

3. Update CHANGELOG.md

4. Create a new tag:

   ```bash
   git tag -a v1.0.1 -m "Hotfix v1.0.1"
   ```

5. Push both branch and tag:
   ```bash
   git push origin hotfix/v1.0.1
   git push origin v1.0.1
   ```

## Beta/RC Releases

For pre-releases:

```bash
# Beta release
git tag -a v1.1.0-beta.1 -m "Beta release v1.1.0-beta.1"
git push origin v1.1.0-beta.1

# Release candidate
git tag -a v1.1.0-rc.1 -m "Release candidate v1.1.0-rc.1"
git push origin v1.1.0-rc.1
```

Users can install pre-releases:

```bash
go get github.com/Prescott-Data/dromos-authkit@v1.1.0-beta.1
```

## Rollback a Release

If a release has critical issues:

1. **Delete the tag locally and remotely**:

   ```bash
   git tag -d v1.0.0
   git push origin :refs/tags/v1.0.0
   ```

2. **Delete the GitHub release**:
   - Go to GitHub Releases
   - Click on the problematic release
   - Delete it

3. **Fix the issue** and create a new patch release

## Release Artifacts

Each release includes:

- **Source code** (automatically by GitHub)
- **Release notes** (generated from commits)
- **Checksums** (generated by goreleaser)

## Go Module Proxy

After pushing a tag:

1. Go's module proxy automatically indexes the module
2. Usually takes 5-10 minutes to appear on pkg.go.dev
3. Force refresh by visiting:
   ```
   https://proxy.golang.org/github.com/Prescott-Data/dromos-authkit/@v/v1.0.0.info
   ```

## Troubleshooting

### Tag already exists

```bash
# Delete local tag
git tag -d v1.0.0

# Delete remote tag
git push origin :refs/tags/v1.0.0

# Recreate tag
git tag -a v1.0.0 -m "Release v1.0.0"
git push origin v1.0.0
```

### Release workflow failed

1. Check GitHub Actions logs
2. Fix the issue
3. Delete the tag and recreate it (workflow will re-run)

### Module not showing on pkg.go.dev

1. Wait 10-15 minutes
2. Try fetching manually:
   ```bash
   GOPROXY=https://proxy.golang.org go get github.com/Prescott-Data/dromos-authkit@v1.0.0
   ```
3. Check if tag follows proper format: `vX.Y.Z`

## Communication

After a release:

1. Announce in GitHub Discussions
2. Update dependent projects
3. Notify users of breaking changes

## Questions?

Open an issue or discussion on GitHub if you need help with releases.
